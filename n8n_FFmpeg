#!/bin/bash

# -------------------------------
# üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ n8n —Å FFmpeg
# -------------------------------

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üü¢ –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã..."
sudo apt update

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Docker
echo "üü¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Docker..."
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# –î–æ–±–∞–≤–ª—è–µ–º Docker GPG –∫–ª—é—á
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

# –î–æ–±–∞–≤–ª—è–µ–º Docker —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
sudo add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –ø–∞–∫–µ—Ç–∞
apt-cache policy docker-ce

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker CE
sudo apt install -y docker-ce
echo "‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

# -------------------------------
# üóÇ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö n8n
# -------------------------------
echo "üìÇ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö n8n..."
cd ~
mkdir -p n8n_data
sudo chown -R 1000:1000 n8n_data
sudo chmod -R 755 n8n_data
echo "‚úÖ –ü–∞–ø–∫–∞ ~/n8n_data –≥–æ—Ç–æ–≤–∞!"

# -------------------------------
# üê≥ –°–æ–∑–¥–∞–Ω–∏–µ compose.yaml —Å FFmpeg
# -------------------------------
echo "üü¢ –°–æ–∑–¥–∞–µ–º compose.yaml —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π FFmpeg..."

cat <<EOF > compose.yaml
services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n_container
    environment:
      - N8N_SECURE_COOKIE=false
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - N8N_EDITOR_BASE_URL=\${EXTERNAL_IP}
      - WEBHOOK_URL=\${EXTERNAL_IP}
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
    ports:
      - "80:5678"
    volumes:
      - /root/n8n_data:/home/node/.n8n
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FFmpeg –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    entrypoint: /bin/bash -c "apt update && apt install -y ffmpeg && n8n start"
EOF

# -------------------------------
# üåê –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP
# -------------------------------
export EXTERNAL_IP=http://"$(hostname -I | awk '{print $1}')"

# -------------------------------
# üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# -------------------------------
echo "üü¢ –ó–∞–ø—É—Å–∫–∞–µ–º n8n —Å Docker Compose..."
sudo -E docker compose up -d

# -------------------------------
# üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
# -------------------------------
echo "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üëâ –û—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ: $EXTERNAL_IP"
